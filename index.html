<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PatiLink - NFC Hayvan Takibi</title>
    <script src="https://cdn.tailwindcss.com"></script> <!-- Stil için Tailwind -->
    <style>
        body { font-family: Arial, sans-serif; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Kayıt  / Giriş Ekranı -->
    <div id="authSection" class="max-w-md mx-auto mt-10 p-6 bg-white rounded shadow">
        <h2 class="text-2xl font-bold mb-4">Kayıt Ol / Giriş Yap</h2>
        <input type="email" id="emailInput" placeholder="E-posta" class="border p-2 w-full mb-2">
        <input type="password" id="passwordInput" placeholder="Şifre" class="border p-2 w-full mb-2">
        <button onclick="registerUser()" class="bg-blue-500 text-white p-2 rounded mr-2">Kayıt Ol</button>
        <button onclick="loginUser()" class="bg-green-500 text-white p-2 rounded">Giriş Yap</button>
        <p id="authMessage" class="text-red-500 mt-2"></p>
    </div>

    <!-- Dashboard (Giriş Sonrası) -->
    <div id="dashboard" class="hidden max-w-2xl mx-auto mt-10 p-6 bg-white rounded shadow">
        <h1 class="text-3xl font-bold mb-4">PatiLink Dashboard</h1>
        <button onclick="logoutUser()" class="bg-red-500 text-white p-2 rounded mb-4">Çıkış Yap</button>
        
        <!-- Profil Oluştur -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold">Hayvan Profili Oluştur</h2>
            <input type="text" id="petName" placeholder="Hayvan Adı" class="border p-2 w-full mb-2">
            <input type="text" id="petBreed" placeholder="Cins" class="border p-2 w-full mb-2">
            <input type="text" id="ownerPhone" placeholder="Sahip Telefon" class="border p-2 w-full mb-2">
            <input type="text" id="ownerEmail" placeholder="Sahip E-posta" class="border p-2 w-full mb-2">
            <button onclick="createPetProfile()" class="bg-blue-500 text-white p-2 rounded">Oluştur</button>
        </div>

        <!-- Profiller Listesi ve İstatistikler -->
        <div id="petList"></div>
    </div>

    <!-- Ziyaretçi Sayfası (NFC Linki Açılınca) -->
    <div id="visitorPage" class="hidden max-w-md mx-auto mt-10 p-6 bg-white rounded shadow">
        <h2 id="visitorPetName" class="text-2xl font-bold mb-4"></h2>
        <p id="visitorPetInfo"></p>
        <button onclick="callOwner()" class="bg-red-500 text-white p-2 rounded mt-4">Sahibi Ara</button>
        <button onclick="sendLocationToOwner()" class="bg-green-500 text-white p-2 rounded mt-4">Konumumu Gönder</button>
        <div id="notification" class="mt-4"></div>
    </div>

    <script>
        // Kullanıcı Sistemi
        let currentUser = null;
        const usersKey = 'patilink_users';
        const currentUserKey = 'patilink_current_user';
        const petsKey = 'patilink_pets'; // Tüm pet'ler kullanıcıya bağlı
        let petStats = {}; // {petId: {views:0, calls:0, locations:[]}}

        function getUsers() {
            return JSON.parse(localStorage.getItem(usersKey)) || {};
        }

        function saveUsers(users) {
            localStorage.setItem(usersKey, JSON.stringify(users));
        }

        function registerUser() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            if (!email || !password) return showAuthMessage('Boş alan bırakma!');
            
            const users = getUsers();
            if (users[email]) return showAuthMessage('Bu e-posta kayıtlı!');
            
            users[email] = { password, pets: [] };
            saveUsers(users);
            showAuthMessage('Kayıt başarılı! Giriş yap.', 'green');
        }

        function loginUser() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const users = getUsers();
            if (users[email] && users[email].password === password) {
                currentUser = email;
                localStorage.setItem(currentUserKey, email);
                loadDashboard();
                showAuthMessage('Giriş başarılı!', 'green');
            } else {
                showAuthMessage('Hatalı e-posta/şifre!');
            }
        }

        function logoutUser() {
            currentUser = null;
            localStorage.removeItem(currentUserKey);
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('visitorPage').classList.add('hidden');
        }

        function showAuthMessage(msg, color = 'red') {
            const el = document.getElementById('authMessage');
            el.textContent = msg;
            el.style.color = color;
        }

        // Dashboard Yükle
        function loadDashboard() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            const users = getUsers();
            const userPets = users[currentUser].pets;
            petStats = JSON.parse(localStorage.getItem('patilink_stats')) || {};
            
            const petListEl = document.getElementById('petList');
            petListEl.innerHTML = '<h2 class="text-xl font-semibold mt-6">Profillerim</h2>';
            userPets.forEach(pet => {
                const stats = petStats[pet.id] || { views: 0, calls: 0, locations: [] };
                petListEl.innerHTML += `
                    <div class="border p-4 mb-4 rounded">
                        <p><strong>${pet.name}</strong> - Link: <a href="?pet=${pet.id}" target="_blank">Aç</a></p>
                        <p>Görüntülenme: ${stats.views}, Aramalar: ${stats.calls}</p>
                        <button onclick="showPetStats('${pet.id}')" class="bg-gray-500 text-white p-1 rounded text-sm">İstatistik Gör</button>
                    </div>
                `;
            });
        }

        // Profil Oluştur
        function createPetProfile() {
            if (!currentUser) return;
            const name = document.getElementById('petName').value;
            const breed = document.getElementById('petBreed').value;
            const phone = document.getElementById('ownerPhone').value;
            const email = document.getElementById('ownerEmail').value;
            if (!name || !phone) return alert('Ad ve telefon zorunlu!');

            const petId = Date.now().toString();
            const pet = { id: petId, name, breed, phone, email, owner: currentUser };

            const users = getUsers();
            users[currentUser].pets.push(pet);
            saveUsers(users);
            if (!petStats[petId]) petStats[petId] = { views: 0, calls: 0, locations: [] };
            localStorage.setItem('patilink_stats', JSON.stringify(petStats));

            alert('Profil oluşturuldu! Link: ?pet=' + petId);
            loadDashboard();
        }

        // İstatistik Göster (Modal Simülasyonu)
        function showPetStats(petId) {
            const stats = petStats[petId];
            const locationsHtml = stats.locations.slice(-5).map(loc => `
                <div class="text-sm">
                    ${new Date(loc.timestamp).toLocaleString('tr-TR')} - ${loc.name} (IP: ${loc.ip || 'Bilinmiyor'}, Koordinat: ${loc.lat},${loc.lng})
                </div>
            `).join('');
            alert(`Görüntülenme: ${stats.views}\nAramalar: ${stats.calls}\nSon Konumlar:\n${locationsHtml || 'Yok'}`);
        }

        // Sayfa Yüklenme (URL'den pet kontrol)
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const petId = urlParams.get('pet');
            if (petId) {
                loadVisitorPage(petId);
            } else {
                const savedUser = localStorage.getItem(currentUserKey);
                if (savedUser) {
                    currentUser = savedUser;
                    loadDashboard();
                }
            }
            petStats = JSON.parse(localStorage.getItem('patilink_stats')) || {};
        };

        // Ziyaretçi Sayfası Yükle
        function loadVisitorPage(petId) {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('visitorPage').classList.remove('hidden');

            // Pet verisini bul (tüm kullanıcıları tara - basitlik için)
            const users = getUsers();
            let pet = null;
            Object.values(users).forEach(user => {
                const found = user.pets.find(p => p.id === petId);
                if (found) pet = found;
            });
            if (!pet) return showNotification('Profil bulunamadı!', 'error');

            currentPet = pet; // Global
            document.getElementById('visitorPetName').textContent = pet.name;
            document.getElementById('visitorPetInfo').textContent = `${pet.breed} - Sahip: ${pet.email || 'Bilinmiyor'}`;

            // Görüntülenme say
            if (!petStats[petId]) petStats[petId] = { views: 0, calls: 0, locations: [] };
            petStats[petId].views++;
            localStorage.setItem('patilink_stats', JSON.stringify(petStats));
        }

        let currentPet = null;

        // Bildirim Göster
        function showNotification(msg, type = 'info') {
            const el = document.getElementById('notification');
            el.textContent = msg;
            el.className = `mt-4 p-2 rounded ${type === 'success' ? 'bg-green-200' : type === 'error' ? 'bg-red-200' : 'bg-blue-200'}`;
        }

        // Sahibi Ara
        async function callOwner() {
            if (!currentPet) return;
            petStats[currentPet.id].calls++;
            localStorage.setItem('patilink_stats', JSON.stringify(petStats));
            window.location.href = `tel:${currentPet.phone}`;
            await addLocationToStats(); // Konum ekle
            showNotification('Arama yapılıyor ve konum gönderildi!', 'success');
        }

        // Konum Gönder (GPS + IP API)
        async function sendLocationToOwner() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    await addLocationToStats(lat, lng);
                    showNotification('Konum gönderildi!', 'success');
                }, () => showNotification('Konum erişimi reddedildi.', 'error'));
            } else {
                showNotification('Tarayıcı konum desteklemiyor.', 'error');
            }
        }

        // Konum Ekleme Fonksiyonu (Ortak)
        async function addLocationToStats(lat = null, lng = null) {
            if (!currentPet) return;
            let locationName = 'Bilinmeyen konum';
            let ip = 'Bilinmiyor';
            try {
                const response =PC = await fetch(`https://api.ipgeolocation.io/ipgeo?apiKey=b647e2a9739c445984120017ef0a3884`);
                const ipData = await response.json();
                ip = ipData.ip;
                locationName = ipData.city + ', ' + ipData.country_name;
                if (ipData.state_prov) locationName += ', ' + ipData.state_prov;
            } catch (error) {
                console.error('IP API hatası:', error);
            }

            if (!petStats[currentPet.id]) petStats[currentPet.id] = { views: 0, calls: 0, locations: [] };
            petStats[currentPet.id].locations.push({
                lat: lat || 'GPS yok',
                lng: lng || 'GPS yok',
                name: locationName,
                ip: ip,
                timestamp: new Date()
            });
            localStorage.setItem('patilink_stats', JSON.stringify(petStats));
        }
    </script>
</body>
</html>
