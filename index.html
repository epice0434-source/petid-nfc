<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetID - Evcil Hayvan Kimlik Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ... (stil dosyaları ve mevcut kodlar değişmedi) ... -->
    <style>
        /* ... (mevcut stiller aynı) ... */
    </style>
</head>
<body class="bg-gray-50 min-h-full">
    <!-- Navigation -->
    <nav class="gradient-bg text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold">🐾 PetID</h1>
            <div class="flex space-x-2 md:space-x-4 items-center" id="navbarUserArea">
                <button onclick="showLogin()" class="bg-white text-purple-600 px-3 md:px-4 py-2 rounded-lg text-sm md:text-base font-medium hover:bg-gray-100 transition">Giriş</button>
                <button onclick="showRegister()" class="bg-purple-800 px-3 md:px-4 py-2 rounded-lg text-sm md:text-base font-medium hover:bg-purple-900 transition">Kayıt</button>
            </div>
        </div>
    </nav>

    <!-- ... (main content ve diğer bölümler aynı) ... -->

    <script>
        // ... (mevcut global değişkenler ve fonksiyonlar aynı) ...

        // --- DEĞİŞİKLİK 1: Public pet profili hem hash hem query parametre ile açılabilmeli ---

        function getPetIdFromUrl() {
            // Hem ?pet=123 hem #pet=123 desteği
            const urlParams = new URLSearchParams(window.location.search);
            let petId = null;
            if (urlParams.has('pet')) {
                petId = parseInt(urlParams.get('pet'));
            } else if (window.location.hash.startsWith('#pet=')) {
                petId = parseInt(window.location.hash.replace('#pet=', ''));
            }
            return petId;
        }

        function setPetProfileLink(petId) {
            // Linki hem hash hem query parametre ile verebiliriz
            return `${window.location.origin}${window.location.pathname}?pet=${petId}`;
        }

        // --- DEĞİŞİKLİK 2: Navbar'da kullanıcı adı göstermek için fonksiyon ---

        function updateNavbarUser() {
            const navbarUserArea = document.getElementById('navbarUserArea');
            if (currentUser) {
                // Kullanıcı adı ve çıkış butonu
                navbarUserArea.innerHTML = `
                    <span class="font-semibold text-white bg-purple-700 px-4 py-2 rounded-lg mr-2">Merhaba, ${currentUser.name}</span>
                    <button onclick="logout()" class="bg-gray-500 text-white px-3 md:px-4 py-2 rounded-lg text-sm md:text-base font-medium hover:bg-gray-600 transition">Çıkış</button>
                `;
            } else {
                // Giriş ve kayıt butonları
                navbarUserArea.innerHTML = `
                    <button onclick="showLogin()" class="bg-white text-purple-600 px-3 md:px-4 py-2 rounded-lg text-sm md:text-base font-medium hover:bg-gray-100 transition">Giriş</button>
                    <button onclick="showRegister()" class="bg-purple-800 px-3 md:px-4 py-2 rounded-lg text-sm md:text-base font-medium hover:bg-purple-900 transition">Kayıt</button>
                `;
            }
        }

        // --- DEĞİŞİKLİK 3: Tüm giriş/çıkış ve dashboard fonksiyonlarında navbar güncellemesi çağrılır ---

        function showLogin() {
            hideAll();
            document.getElementById('loginForm').classList.remove('hidden');
            window.location.hash = '';
            updateNavbarUser();
        }

        function showRegister() {
            hideAll();
            document.getElementById('registerForm').classList.remove('hidden');
            window.location.hash = '';
            updateNavbarUser();
        }

        function showDashboard() {
            hideAll();
            document.getElementById('dashboard').classList.remove('hidden');
            updateStats();
            displayPets();
            window.location.hash = '';
            updateNavbarUser();
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            hideAll();
            document.getElementById('welcomeSection').classList.remove('hidden');
            window.location.hash = '';
            updateNavbarUser();
        }

        // --- DEĞİŞİKLİK 4: Kayıt ve girişte navbar güncellemesi ---

        function register(event) {
            event.preventDefault();
            loadCloudData();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;
            if (users.find(u => u.email === email)) {
                showMessage('Bu e-posta adresi zaten kayıtlı!', 'error');
                return;
            }
            const user = {
                id: Date.now(),
                name,
                email,
                phone,
                password,
                createdAt: new Date().toISOString()
            };
            users.push(user);
            const success = saveCloudData();
            if (!success) {
                showMessage('Kayıt sırasında hata oluştu, tekrar deneyin!', 'error');
                return;
            }
            currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showMessage('Kayıt başarılı! Hoş geldiniz!', 'success');
            showDashboard(); // burada navbar güncellenir
        }

        function login(event) {
            event.preventDefault();
            loadCloudData();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMessage('Giriş başarılı!', 'success');
                showDashboard(); // burada navbar güncellenir
            } else {
                showMessage('E-posta veya şifre hatalı! Lütfen bilgilerinizi kontrol edin.', 'error');
            }
        }

        // --- DEĞİŞİKLİK 5: Hayvan profili eklerken link query parametre ile veriliyor ---
        function addPet(event) {
            event.preventDefault();
            // ... (mevcut kod aynı şekilde devam eder) ...
            const customInfoBoxes = [];
            const customTitles = document.querySelectorAll('[name^="customTitle"]');
            const customContents = document.querySelectorAll('[name^="customContent"]');
            for (let i = 0; i < customTitles.length; i++) {
                if (customTitles[i].value.trim() || customContents[i].value.trim()) {
                    customInfoBoxes.push({
                        title: customTitles[i].value.trim(),
                        content: customContents[i].value.trim()
                    });
                }
            }
            const petId = Date.now();
            const petData = {
                // ... (diğer alanlar) ...
                link: setPetProfileLink(petId)
            };
            pets.push(petData);
            // ... (analytics ve diğer işlemler aynı) ...
            const success = saveCloudData();
            if (!success) {
                showMessage('Hayvan profili kaydedilirken hata oluştu!', 'error');
                return;
            }
            // ... (form reset, dashboarda yönlendirme vs.) ...
            showDashboard();
            setTimeout(() => {
                showSuccessModal(petData.link);
            }, 100);
        }

        // --- DEĞİŞİKLİK 6: Uygulama başlatırken hem hash hem query parametre kontrolü ---
        function init() {
            syncWithCloudDatabase();
            // PRIORITY: Pet linki kontrolü
            const petId = getPetIdFromUrl();
            if (petId) {
                console.log(`Pet ID araniyor: ${petId}, Toplam pet sayisi: ${pets.length}`);
                const pet = pets.find(p => p.id === petId);
                if (pet) {
                    console.log(`Pet bulundu: ${pet.name}`);
                    viewPetProfilePublic(petId);
                    updateNavbarUser();
                    return;
                } else {
                    console.log(`Pet bulunamadi: ${petId}`);
                    showPetNotFoundMessage();
                    updateNavbarUser();
                    return;
                }
            }
            // Pet linki yoksa kullanıcı girişi kontrol et
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showDashboard();
            } else {
                hideAll();
                document.getElementById('welcomeSection').classList.remove('hidden');
                updateNavbarUser();
            }
            window.addEventListener('hashchange', handleHashChange);
            window.addEventListener('popstate', handleHashChange); // query parametre desteği için
        }

        // --- DEĞİŞİKLİK 7: Hash ve query parametre değişiminde pet profili açma ---
        function handleHashChange() {
            syncWithCloudDatabase();
            const petId = getPetIdFromUrl();
            if (petId) {
                const pet = pets.find(p => p.id === petId);
                if (pet) {
                    viewPetProfilePublic(petId);
                    updateNavbarUser();
                    return;
                } else {
                    showPetNotFoundMessage();
                    updateNavbarUser();
                    return;
                }
            }
            if (currentUser && !window.location.hash && !window.location.search) {
                showDashboard();
            } else if (!window.location.hash && !window.location.search) {
                hideAll();
                document.getElementById('welcomeSection').classList.remove('hidden');
                updateNavbarUser();
            }
        }

        // --- DEĞİŞİKLİK 8: Sayfa açılışında navbarı güncelle ---
        document.addEventListener('DOMContentLoaded', updateNavbarUser);

        // --- INIT çağrısı ---
        init();
    </script>
    <!-- ... (mevcut scriptler, Cloudflare ekleri vs. değişmedi) ... -->
</body>
</html>
