<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PatiLink - NFC Hayvan Takip Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, doc, addDoc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, serverTimestamp, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCZSnh9jWibR4a0Pc6RKBDYlGZNXP_Tiu8",
        authDomain: "petnfc-46178.firebaseapp.com",
        projectId: "petnfc-46178",
        storageBucket: "petnfc-46178.appspot.com",
        messagingSenderId: "942096749783",
        appId: "1:942096749783:web:afcd7f8e4f4f109f3c4c92",
        measurementId: "G-XS8LXGR545"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Make Firebase functions globally available to the main script
      window.firebase = {
        auth, db, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
        collection, doc, addDoc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, serverTimestamp, increment, arrayUnion
      };
    </script>

    <style>
        body { box-sizing: border-box; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .pet-card { transition: all 0.3s ease; transform: translateY(0); }
        .pet-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .stats-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .location-card { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .call-button { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .call-button:hover { background: linear-gradient(135deg, #38f9d7 0%, #43e97b 100%); }
        .emergency-button { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .modal { backdrop-filter: blur(10px); z-index: 50; }
        .form-input { transition: all 0.3s ease; }
        .form-input:focus { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .qr-code { background: linear-gradient(45deg, #667eea, #764ba2); padding: 20px; border-radius: 15px; }
        .feature-card { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .premium-badge { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
        .notification { animation: slideIn 0.3s ease-out; z-index: 100; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .image-gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .gallery-item { aspect-ratio: 1; border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .gallery-item:hover { transform: scale(1.05); }
        .tab-button.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .admin-card { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .admin-stats { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .danger-zone { background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%); }
    </style>
</head>
<body class="min-h-full bg-gray-50">
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <a href="/" class="text-2xl font-bold text-white">🐾 PatiLink</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="loginBtn" class="text-white hover:text-gray-200 px-3 py-2 rounded-md text-sm font-medium">Giriş Yap</button>
                    <button id="registerBtn" class="bg-white text-purple-600 hover:bg-gray-100 px-4 py-2 rounded-md text-sm font-medium">Üye Ol</button>
                </div>
            </div>
        </div>
    </nav>

    <div id="mainContent" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="welcomeSection" class="mb-12">
            <div class="text-center mb-16">
                <h2 class="text-5xl font-bold text-gray-900 mb-6">Hayvanınızı NFC ile Koruyun</h2>
                <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">Tamamen ücretsiz! Kaybolduğunda hemen bulunabilsin. Tasmasına NFC tag takın, detaylı profilini oluşturun ve anlık takip edin.</p>
            </div>

            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-16">
                <div class="feature-card p-6 rounded-xl shadow-lg text-center">
                    <div class="text-5xl mb-4">📱</div>
                    <h3 class="text-xl font-semibold mb-3">NFC Teknolojisi</h3>
                    <p class="text-gray-700">Telefon yaklaştırıldığında otomatik profil açılır</p>
                </div>
                <div class="feature-card p-6 rounded-xl shadow-lg text-center">
                    <div class="text-5xl mb-4">📊</div>
                    <h3 class="text-xl font-semibold mb-3">Anlık İstatistikler</h3>
                    <p class="text-gray-700">Kaç kişinin taradığını ve aradığını görün</p>
                </div>
                <div class="feature-card p-6 rounded-xl shadow-lg text-center">
                    <div class="text-5xl mb-4">📍</div>
                    <h3 class="text-xl font-semibold mb-3">Konum Takibi</h3>
                    <p class="text-gray-700">Hayvanınızı bulan kişilerin konumunu görün</p>
                </div>
                <div class="feature-card p-6 rounded-xl shadow-lg text-center">
                    <div class="text-5xl mb-4">🚨</div>
                    <h3 class="text-xl font-semibold mb-3">Acil Durum</h3>
                    <p class="text-gray-700">Tek tıkla arama ve yönlendirme</p>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl p-8 mb-16">
                <h3 class="text-3xl font-bold text-center mb-12">Nasıl Çalışır?</h3>
                <div class="grid md:grid-cols-5 gap-8">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-2xl font-bold text-purple-600">1</span></div>
                        <h4 class="font-semibold mb-2">Üye Olun</h4><p class="text-sm text-gray-600">Hesap oluşturun</p>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-2xl font-bold text-purple-600">2</span></div>
                        <h4 class="font-semibold mb-2">Profil Oluşturun</h4><p class="text-sm text-gray-600">Hayvan bilgilerini girin</p>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-2xl font-bold text-purple-600">3</span></div>
                        <h4 class="font-semibold mb-2">NFC Tag İçin İletişim</h4><p class="text-sm text-gray-600">Biz NFC'yi programlayıp gönderiyoruz</p>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-2xl font-bold text-purple-600">4</span></div>
                        <h4 class="font-semibold mb-2">Tasmasına Takın</h4><p class="text-sm text-gray-600">NFC tag'i hayvanın tasmasına takın</p>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-2xl font-bold text-purple-600">5</span></div>
                        <h4 class="font-semibold mb-2">Güvende Olun</h4><p class="text-sm text-gray-600">Anlık takip edin</p>
                    </div>
                </div>
            </div>

            <div class="text-center mb-16">
                <h3 class="text-3xl font-bold mb-8">Üyelik Planları</h3>
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="bg-white rounded-xl shadow-lg p-8 border-2 border-green-500 relative">
                        <div class="premium-badge absolute -top-3 left-1/2 transform -translate-x-1/2 px-4 py-1 rounded-full text-sm font-semibold">Tamamen Ücretsiz</div>
                        <h4 class="text-xl font-semibold mb-4">Temel</h4>
                        <div class="text-3xl font-bold mb-4">₺0</div>
                        <ul class="text-left space-y-2 mb-6">
                            <li>✅ Sınırsız Hayvan Profili</li>
                            <li>✅ Tüm Özellikler</li>
                            <li>✅ NFC & QR Kod Desteği</li>
                            <li>✅ Detaylı İstatistikler</li>
                            <li>✅ Konum Takibi</li>
                            <li>✅ Fotoğraf Galerisi</li>
                            <li>✅ Sosyal Medya Linkleri</li>
                        </ul>
                        <button onclick="showModal('registerModal')" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg">Ücretsiz Başla</button>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <h4 class="text-xl font-semibold mb-4">NFC Tag Satışı</h4>
                        <div class="text-3xl font-bold mb-4" id="nfcPriceDisplay">₺25</div>
                        <ul class="text-left space-y-2 mb-6">
                            <li>🏷️ Hazır programlanmış NFC tag</li>
                            <li>📦 Ücretsiz kargo</li>
                            <li>🎨 Özel tasarım seçenekleri</li>
                            <li>💧 Su geçirmez</li>
                            <li>🔧 Kurulum desteği</li>
                            <li>📞 Teknik destek</li>
                        </ul>
                        <button onclick="window.open('tel:05386694530', '_blank')" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 rounded-lg">📞 Sipariş Ver</button>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <h4 class="text-xl font-semibold mb-4">Pet Shop Ortaklığı</h4>
                        <div class="text-3xl font-bold mb-4">İletişim</div>
                        <ul class="text-left space-y-2 mb-6">
                            <li>🏪 Pet shop entegrasyonu</li>
                            <li>💰 Komisyon sistemi</li>
                            <li>📊 Satış raporları</li>
                            <li>🎯 Pazarlama desteği</li>
                            <li>📞 Özel müşteri hattı</li>
                            <li>🚀 Büyüme fırsatları</li>
                        </ul>
                        <button onclick="window.open('tel:05386694530', '_blank')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg">📞 Ortaklık İçin Ara</button>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <a href="?admin=true" class="text-xs text-gray-400 hover:text-gray-600">•</a>
            </div>
        </div>
    </div>
    <div id="userDashboard" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900">Hayvanlarım</h2>
            <button id="addPetBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium">+ Yeni Hayvan Ekle</button>
        </div>
        <div id="petsList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>
    <div id="adminDashboard" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900">👑 Admin Paneli</h2>
            <button onclick="showWelcomeSection()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium">← Ana Sayfa</button>
        </div>
        <div class="grid md:grid-cols-5 gap-6 mb-8">
            <div class="admin-stats p-6 rounded-xl shadow-lg text-center"><div class="text-4xl font-bold text-purple-600" id="totalUsers">0</div><div class="text-gray-700 font-medium">Toplam Kullanıcı</div></div>
            <div class="admin-stats p-6 rounded-xl shadow-lg text-center"><div class="text-4xl font-bold text-blue-600" id="totalPets">0</div><div class="text-gray-700 font-medium">Toplam Hayvan</div></div>
            <div class="admin-stats p-6 rounded-xl shadow-lg text-center"><div class="text-4xl font-bold text-green-600" id="activePets">0</div><div class="text-gray-700 font-medium">Aktif Profil</div></div>
            <div class="admin-stats p-6 rounded-xl shadow-lg text-center"><div class="text-4xl font-bold text-orange-600" id="totalViews">0</div><div class="text-gray-700 font-medium">Toplam Görüntülenme</div></div>
            <div class="admin-stats p-6 rounded-xl shadow-lg text-center"><div class="text-4xl font-bold text-red-600" id="totalCalls">0</div><div class="text-gray-700 font-medium">Toplam Arama</div></div>
        </div>
        <div class="bg-white rounded-lg shadow-lg">
            <div class="flex border-b">
                <button class="admin-tab-btn px-6 py-4 font-medium text-purple-600 border-b-2 border-purple-600" onclick="switchAdminTab('users')">👥 Kullanıcılar</button>
                <button class="admin-tab-btn px-6 py-4 font-medium text-gray-500 hover:text-purple-600" onclick="switchAdminTab('pets')">🐾 Hayvanlar</button>
                <button class="admin-tab-btn px-6 py-4 font-medium text-gray-500 hover:text-purple-600" onclick="switchAdminTab('analytics')">📊 Analitik</button>
                <button class="admin-tab-btn px-6 py-4 font-medium text-gray-500 hover:text-purple-600" onclick="switchAdminTab('settings')">⚙️ Ayarlar</button>
            </div>
            <div id="usersTab" class="admin-tab-content p-6"><h3 class="text-xl font-semibold mb-4">Kullanıcı Listesi</h3><div class="overflow-x-auto"><table class="w-full table-auto"><thead><tr class="bg-gray-50"><th class="px-4 py-2 text-left">ID</th><th class="px-4 py-2 text-left">Ad Soyad</th><th class="px-4 py-2 text-left">E-posta</th><th class="px-4 py-2 text-left">Telefon</th><th class="px-4 py-2 text-left">Kayıt Tarihi</th><th class="px-4 py-2 text-left">Hayvan Sayısı</th><th class="px-4 py-2 text-left">İşlemler</th></tr></thead><tbody id="usersTableBody"></tbody></table></div></div>
            <div id="petsTab" class="admin-tab-content p-6 hidden"><h3 class="text-xl font-semibold mb-4">Hayvan Listesi</h3><div class="overflow-x-auto"><table class="w-full table-auto"><thead><tr class="bg-gray-50"><th class="px-4 py-2 text-left">ID</th><th class="px-4 py-2 text-left">Ad</th><th class="px-4 py-2 text-left">Tür</th><th class="px-4 py-2 text-left">Sahip</th><th class="px-4 py-2 text-left">Görüntülenme</th><th class="px-4 py-2 text-left">Arama</th><th class="px-4 py-2 text-left">Oluşturulma</th><th class="px-4 py-2 text-left">İşlemler</th></tr></thead><tbody id="petsTableBody"></tbody></table></div></div>
            <div id="analyticsTab" class="admin-tab-content p-6 hidden"><h3 class="text-xl font-semibold mb-6">Detaylı Analitik</h3><div class="grid md:grid-cols-2 gap-6 mb-8"><div class="bg-gradient-to-r from-blue-50 to-blue-100 p-6 rounded-xl"><h4 class="text-lg font-semibold mb-4 text-blue-800">📈 Günlük İstatistikler</h4><div class="space-y-2"><div class="flex justify-between"><span>Bugün kayıt olan:</span><span class="font-bold" id="todayRegistrations">0</span></div><div class="flex justify-between"><span>Bugün eklenen hayvan:</span><span class="font-bold" id="todayPets">0</span></div><div class="flex justify-between"><span>Bugün görüntülenme:</span><span class="font-bold" id="todayViews">0</span></div><div class="flex justify-between"><span>Bugün arama:</span><span class="font-bold" id="todayCalls">0</span></div></div></div><div class="bg-gradient-to-r from-green-50 to-green-100 p-6 rounded-xl"><h4 class="text-lg font-semibold mb-4 text-green-800">🏆 En Popüler</h4><div class="space-y-2"><div><span class="text-sm text-gray-600">En çok görüntülenen:</span><div class="font-bold" id="mostViewedPet">-</div></div><div><span class="text-sm text-gray-600">En çok aranan:</span><div class="font-bold" id="mostCalledPet">-</div></div><div><span class="text-sm text-gray-600">En aktif kullanıcı:</span><div class="font-bold" id="mostActivePetOwner">-</div></div></div></div></div><div class="bg-yellow-50 p-6 rounded-xl"><h4 class="text-lg font-semibold mb-4 text-yellow-800">📍 Konum Verileri</h4><div class="grid md:grid-cols-3 gap-4"><div class="text-center"><div class="text-2xl font-bold text-yellow-600" id="totalLocations">0</div><div class="text-sm text-gray-600">Toplam Konum</div></div><div class="text-center"><div class="text-2xl font-bold text-yellow-600" id="uniqueLocations">0</div><div class="text-sm text-gray-600">Benzersiz Konum</div></div><div class="text-center"><div class="text-2xl font-bold text-yellow-600" id="avgLocationsPerPet">0</div><div class="text-sm text-gray-600">Hayvan Başına Ort.</div></div></div></div></div>
            <div id="settingsTab" class="admin-tab-content p-6 hidden"></div>
        </div>
    </div>
    <div id="petProfileView" class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden"><div id="petProfileContent"></div></div>
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50"><div class="bg-white rounded-lg p-8 max-w-md w-full mx-4"><h3 class="text-2xl font-bold mb-6 text-center">Giriş Yap</h3><form id="loginForm"><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">E-posta</label><input type="email" name="email" class="form-input w-full px-3 py-2 border border-gray-300 rounded-lg" required></div><div class="mb-6"><label class="block text-gray-700 text-sm font-bold mb-2">Şifre</label><input type="password" name="password" class="form-input w-full px-3 py-2 border border-gray-300 rounded-lg" required></div><button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Giriş Yap</button></form><button id="closeLoginModal" class="mt-4 w-full text-gray-500 hover:text-gray-700">İptal</button></div></div>
    <div id="registerModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50"><div class="bg-white rounded-lg p-8 max-w-md w-full mx-4"><h3 class="text-2xl font-bold mb-6 text-center">Üye Ol</h3><form id="registerForm"><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">Ad Soyad</label><input type="text" name="name" class="form-input w-full px-3 py-2 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">E-posta</label><input type="email" name="email" class="form-input w-full px-3 py-2 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">Telefon</label><input type="tel" name="phone" class="form-input w-full px-3 py-2 border border-gray-300 rounded-lg" required></div><div class="mb-6"><label class="block text-gray-700 text-sm font-bold mb-2">Şifre</label><input type="password" name="password" class="form-input w-full px-3 py-2 border border-gray-300 rounded-lg" required></div><button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Üye Ol</button></form><button id="closeRegisterModal" class="mt-4 w-full text-gray-500 hover:text-gray-700">İptal</button></div></div>
    <div id="addPetModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50"><div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto"></div></div>
    <div id="editPetModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50"><div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto"></div></div>
    <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script type="module">
        // --- GLOBAL STATE ---
        let currentUser = null;
        let photoGallery = [], videoGallery = [];
        let editPhotoGallery = [], editVideoGallery = [];
        let currentEditingPetId = null;

        // --- DOM Elements ---
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const addPetBtn = document.getElementById('addPetBtn');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const addPetForm = document.getElementById('addPetForm');
        const editPetForm = document.getElementById('editPetForm');
        
        // --- UTILITY FUNCTIONS ---
        const showNotification = (message, type = 'info') => {
            const container = document.getElementById('notificationContainer');
            if (!container) return;
            const notif = document.createElement('div');
            const typeClasses = { success: 'border-green-500', error: 'border-red-500', info: 'border-blue-500' };
            notif.className = `notification bg-white border-l-4 p-4 rounded-lg shadow-lg max-w-sm ${typeClasses[type]}`;
            notif.innerHTML = `<div class="flex items-center"><p class="flex-1">${message}</p><button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-400 hover:text-gray-600">&times;</button></div>`;
            container.appendChild(notif);
            setTimeout(() => notif.remove(), 5000);
        };
        const showModal = (id) => document.getElementById(id)?.classList.remove('hidden');
        const hideModal = (id) => document.getElementById(id)?.classList.add('hidden');
        const getAnimalEmoji = (type) => ({'köpek':'🐕','kedi':'🐱','kuş':'🐦','hamster':'🐹','tavşan':'🐰','balık':'🐠','diğer':'🐾'}[type]||'🐾');
        const calculateAge = (birthDateStr) => {
            if (!birthDateStr) return 'Bilinmiyor';
            const birthDate = new Date(birthDateStr);
            if (isNaN(birthDate.getTime())) return 'Geçersiz Tarih';
            const ageDifMs = Date.now() - birthDate.getTime();
            const ageDate = new Date(ageDifMs);
            const years = Math.abs(ageDate.getUTCFullYear() - 1970);
            return `${years} yaş`;
        };
        const getFormDataObject = (form) => Object.fromEntries(new FormData(form).entries());

        // --- UI STATE MANAGEMENT ---
        const updateNavigation = () => {
            if (currentUser) {
                loginBtn.textContent = 'Çıkış Yap';
                registerBtn.style.display = 'none';
            } else {
                loginBtn.textContent = 'Giriş Yap';
                registerBtn.style.display = 'block';
            }
        };
        const showUserDashboard = () => {
            document.getElementById('welcomeSection').classList.add('hidden');
            document.getElementById('petProfileView').classList.add('hidden');
            document.getElementById('adminDashboard')?.classList.add('hidden');
            document.getElementById('userDashboard').classList.remove('hidden');
            renderPetsList();
        };
        const showWelcomeSection = () => {
            document.getElementById('welcomeSection').classList.remove('hidden');
            document.getElementById('userDashboard').classList.add('hidden');
            document.getElementById('petProfileView').classList.add('hidden');
            document.getElementById('adminDashboard')?.classList.add('hidden');
            if (!window.location.search.includes('pet=')) {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        };
        const showAdminLogin = () => {
            const password = prompt('Admin şifresi:');
            if (password === 'irem1234') {
                showAdminDashboard();
            } else {
                showNotification('Yanlış şifre!', 'error');
                window.location.href = window.location.pathname;
            }
        };
        const showAdminDashboard = () => {
            // Your admin dashboard logic here
            console.log("Admin dashboard is loading...");
        };

        // --- Core Auth Listener ---
        window.firebase.onAuthStateChanged(window.firebase.auth, async (user) => {
            const urlParams = new URLSearchParams(window.location.search);
            const petId = urlParams.get('pet');
            const isAdmin = urlParams.get('admin') === 'true';

            if (user) {
                try {
                    const userDoc = await window.firebase.getDoc(window.firebase.doc(window.firebase.db, "users", user.uid));
                    if (userDoc.exists()) {
                        currentUser = { uid: user.uid, ...userDoc.data() };
                        if (petId) showPetProfile(petId);
                        else if (isAdmin) showAdminLogin();
                        else showUserDashboard();
                    } else { throw new Error("Kullanıcı veritabanında bulunamadı."); }
                } catch (error) {
                    console.error("Auth state error:", error);
                    showNotification('Kullanıcı verileri yüklenemedi, çıkış yapılıyor.', 'error');
                    logout();
                }
            } else {
                currentUser = null;
                if (petId) showPetProfile(petId);
                else if (isAdmin) showAdminLogin();
                else showWelcomeSection();
            }
            updateNavigation();
        });

        // --- Firebase Auth Functions ---
        const handleRegister = async (e) => {
            e.preventDefault();
            const { name, email, phone, password } = getFormDataObject(e.target);
            try {
                const cred = await window.firebase.createUserWithEmailAndPassword(window.firebase.auth, email, password);
                await window.firebase.setDoc(window.firebase.doc(window.firebase.db, "users", cred.user.uid), {
                    name, email, phone, registrationDate: window.firebase.serverTimestamp()
                });
                hideModal('registerModal');
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') showNotification('Bu e-posta adresi zaten kayıtlı.', 'error');
                else showNotification(`Kayıt hatası: ${error.message}`, 'error');
            }
        };

        const handleLogin = async (e) => {
            e.preventDefault();
            const { email, password } = getFormDataObject(e.target);
            try {
                await window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password);
                hideModal('loginModal');
            } catch (error) { showNotification("E-posta veya şifre hatalı.", 'error'); }
        };
        
        const logout = () => window.firebase.signOut(window.firebase.auth).catch(err => showNotification('Çıkış hatası', 'error'));

        // --- Your Original Functions (Now Connected to Firebase) ---
        
        const handleAddPet = async (e) => {
            e.preventDefault();
            if (!currentUser) return showNotification('Önce giriş yapmalısınız.', 'error');
            
            const data = getFormDataObject(e.target);
            const customFields = [];
            document.querySelectorAll('#customFieldsList .flex.gap-2').forEach(div => {
                const inputs = div.querySelectorAll('input');
                if(inputs.length === 2 && inputs[0].value && inputs[1].value) {
                    customFields.push({ label: inputs[0].value, value: inputs[1].value });
                }
            });

            const newPetData = { ...data, ownerId: currentUser.uid, ownerInfo: { name: currentUser.name, phone: currentUser.phone }, photoGallery, videoGallery, customFields, views: 0, calls: 0, locations: [], createdAt: window.firebase.serverTimestamp() };
            
            try {
                const docRef = await window.firebase.addDoc(window.firebase.collection(window.firebase.db, "pets"), newPetData);
                const publicLink = `${window.location.origin}${window.location.pathname}?pet=${docRef.id}`;
                await window.firebase.updateDoc(docRef, { link: publicLink });

                hideModal('addPetModal');
                e.target.reset();
                photoGallery = []; videoGallery = [];
                updatePhotoGallery(); updateVideoGallery();
                showNotification('Hayvan profili başarıyla oluşturuldu!', 'success');
                renderPetsList();
            } catch (error) { showNotification('Profil oluşturulamadı: ' + error.message, 'error'); }
        };

        const handleEditPet = async (e) => {
            e.preventDefault();
            if (!currentEditingPetId) return showNotification('Düzenlenecek hayvan bulunamadı.', 'error');

            const data = getFormDataObject(e.target);
            const customFields = []; // Implement custom field logic for edit modal if needed
            const updatedData = {...data, photoGallery: editPhotoGallery, videoGallery: editVideoGallery, customFields };
            delete updatedData.petId;

            try {
                await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, "pets", currentEditingPetId), updatedData);
                hideModal('editPetModal');
                showNotification('Profil güncellendi!', 'success');
                renderPetsList();
                currentEditingPetId = null;
            } catch (error) { showNotification('Güncelleme hatası: ' + error.message, 'error'); }
        };

        const deletePet = async (petId) => {
            if (!confirm("Bu profili silmek istediğinizden emin misiniz?")) return;
            try {
                await window.firebase.deleteDoc(window.firebase.doc(window.firebase.db, "pets", petId));
                showNotification('Profil silindi.', 'success');
                renderPetsList();
            } catch(e) { showNotification('Silme hatası: ' + e.message, 'error'); }
        };
        
        const renderPetsList = async () => {
            const listDiv = document.getElementById('petsList');
            if (!currentUser || !listDiv) return;
            listDiv.innerHTML = '<p>Yükleniyor...</p>';
            
            const q = window.firebase.query(window.firebase.collection(window.firebase.db, "pets"), where("ownerId", "==", currentUser.uid));
            const snapshot = await window.firebase.getDocs(q);
            listDiv.innerHTML = '';

            if (snapshot.empty) {
                listDiv.innerHTML = `<div class="col-span-full text-center py-12"><div class="text-6xl mb-4">🐾</div><h3 class="text-xl font-semibold text-gray-600 mb-2">Henüz hayvan profili oluşturmadınız</h3><p class="text-gray-500 mb-6">İlk hayvan profilinizi oluşturmak için butona tıklayın</p><button onclick="showModal('addPetModal')" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium">🐾 İlk Profilimi Oluştur</button></div>`;
                return;
            }

            snapshot.forEach(doc => {
                const pet = { id: doc.id, ...doc.data() };
                const card = document.createElement('div');
                card.className = 'pet-card bg-white rounded-xl shadow-lg p-6';
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-900">${pet.petName}</h3>
                        <div class="flex space-x-2">
                            <button onclick="openEditPetModal('${pet.id}')" class="text-blue-600 p-2 rounded-lg hover:bg-blue-50">✏️</button>
                            <button onclick="deletePet('${pet.id}')" class="text-red-600 p-2 rounded-lg hover:bg-red-50">🗑️</button>
                        </div>
                    </div>
                    ${pet.photo ? `<div class="mb-4"><img src="${pet.photo}" alt="${pet.petName}" class="w-full h-48 object-cover rounded-lg" onerror="this.parentElement.style.display='none'"></div>` : `<div class="mb-4 h-48 bg-gradient-to-br from-purple-100 to-pink-100 rounded-lg flex items-center justify-center"><div class="text-6xl">${getAnimalEmoji(pet.petType)}</div></div>`}
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between"><span class="text-gray-600">Tür:</span><span class="font-medium">${pet.petType}</span></div>
                        ${pet.breed ? `<div class="flex justify-between"><span class="text-gray-600">Cins:</span><span class="font-medium">${pet.breed}</span></div>` : ''}
                        ${pet.birthDate ? `<div class="flex justify-between"><span class="text-gray-600">Yaş:</span><span class="font-medium">${calculateAge(pet.birthDate)}</span></div>` : ''}
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="stats-card text-white p-3 rounded-lg text-center"><div class="text-2xl font-bold">${pet.views || 0}</div><div class="text-sm">Görüntülenme</div></div>
                        <div class="location-card text-white p-3 rounded-lg text-center"><div class="text-2xl font-bold">${pet.calls || 0}</div><div class="text-sm">Arama</div></div>
                    </div>
                    <div class="space-y-2">
                        <a href="${pet.link}" target="_blank" class="block w-full text-center bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-medium">👁️ Profili Görüntüle</a>
                        <button onclick="copyPetLink('${pet.link}')" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg font-medium">🔗 Linki Kopyala</button>
                    </div>
                `;
                listDiv.appendChild(card);
            });
        };

        const showPetProfile = async (petId) => {
            const petDocRef = window.firebase.doc(window.firebase.db, "pets", petId);
            const petDoc = await window.firebase.getDoc(petDocRef);

            if (!petDoc.exists()) return showNotification('Bu profile ulaşılamıyor.', 'error');
            
            if (!currentUser || currentUser.uid !== petDoc.data().ownerId) {
                await window.firebase.updateDoc(petDocRef, { views: window.firebase.increment(1) });
            }
            
            const updatedPetDoc = await window.firebase.getDoc(petDocRef);
            const pet = {id: updatedPetDoc.id, ...updatedPetDoc.data()};

            showWelcomeSection();
            document.getElementById('welcomeSection').classList.add('hidden');
            document.getElementById('userDashboard').classList.add('hidden');
            document.getElementById('petProfileView').classList.remove('hidden');
            
            const content = document.getElementById('petProfileContent');
            content.innerHTML = ``;
        };

        const callOwner = async (phone, petId) => {
            await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, "pets", petId), { calls: window.firebase.increment(1) });
            window.open(`tel:${phone}`);
        };

        const shareLocation = (petId) => {
            if (!navigator.geolocation) return showNotification('Tarayıcınız konum paylaşımını desteklemiyor.', 'error');
            navigator.geolocation.getCurrentPosition(async (position) => {
                const location = { lat: position.coords.latitude, lng: position.coords.longitude, timestamp: new Date() };
                await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, "pets", petId), { locations: window.firebase.arrayUnion(location) });
                showNotification('Konum başarıyla paylaşıldı!', 'success');
            }, () => showNotification('Konum alınamadı. Lütfen izinleri kontrol edin.', 'error'));
        };
        
        const openEditPetModal = async (petId) => {
            const petDoc = await window.firebase.getDoc(window.firebase.doc(window.firebase.db, "pets", petId));
            if (!petDoc.exists()) return showNotification("Hayvan bulunamadı.", 'error');

            currentEditingPetId = petId;
            const pet = petDoc.data();
            
            const form = document.getElementById('editPetForm');
            for(const key in pet){
                if(form.elements[key]) {
                    form.elements[key].value = pet[key];
                }
            }
            document.getElementById('editPetId').value = petId;

            editPhotoGallery = pet.photoGallery || [];
            editVideoGallery = pet.videoGallery || [];
            updateEditPhotoGallery();
            updateEditVideoGallery();
            showModal('editPetModal');
        };

        const copyPetLink = (link) => { navigator.clipboard.writeText(link).then(() => showNotification('Link kopyalandı!', 'success')); };
        const switchTab = (event, tabName) => {
            const modal = event.target.closest('.modal');
            modal.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            modal.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            modal.querySelector(`#${tabName}Tab`).classList.remove('hidden');
            event.target.classList.add('active');
        };
        const switchEditTab = (tabName) => {
            const modal = document.getElementById('editPetModal');
            modal.querySelectorAll('.edit-tab-content').forEach(tab => tab.classList.add('hidden'));
            modal.querySelectorAll('.edit-tab-button').forEach(btn => btn.classList.remove('active'));
            modal.querySelector(`#edit${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`).classList.remove('hidden');
            event.target.classList.add('active');
        };
        
        const updatePhotoGallery = () => { /* ... Unchanged ... */ };
        const addPhoto = () => { /* ... Unchanged ... */ };
        const removePhoto = (index) => { /* ... Unchanged ... */ };
        const updateVideoGallery = () => { /* ... Unchanged ... */ };
        const addVideo = () => { /* ... Unchanged ... */ };
        const removeVideo = (index) => { /* ... Unchanged ... */ };
        const updateEditPhotoGallery = () => { /* ... Unchanged ... */ };
        const addEditPhoto = () => { /* ... Unchanged ... */ };
        const removeEditPhoto = (index) => { /* ... Unchanged ... */ };
        const updateEditVideoGallery = () => { /* ... Unchanged ... */ };
        const addEditVideo = () => { /* ... Unchanged ... */ };
        const removeEditVideo = (index) => { /* ... Unchanged ... */ };
        const addCustomField = () => { /* ... Unchanged ... */ };
        const addEditCustomField = () => { /* ... Unchanged ... */ };
        const openImageModal = (url) => { /* ... Unchanged ... */ };

        // --- Event Listeners ---
        loginBtn.addEventListener('click', () => currentUser ? logout() : showModal('loginModal'));
        registerBtn.addEventListener('click', () => showModal('registerModal'));
        addPetBtn.addEventListener('click', () => {
            addPetForm.reset();
            photoGallery = []; videoGallery = [];
            // updatePhotoGallery(); updateVideoGallery();
            showModal('addPetModal');
        });
        loginForm.addEventListener('submit', handleLogin);
        registerForm.addEventListener('submit', handleRegister);
        addPetForm.addEventListener('submit', handleAddPet);
        editPetForm.addEventListener('submit', handleEditPet);
        document.getElementById('closeLoginModal').addEventListener('click', () => hideModal('loginModal'));
        document.getElementById('closeRegisterModal').addEventListener('click', () => hideModal('registerModal'));
        document.getElementById('closeAddPetModal').addEventListener('click', () => hideModal('addPetModal'));
        document.getElementById('closeEditPetModal').addEventListener('click', () => hideModal('editPetModal'));

        // --- MAKE ALL FUNCTIONS GLOBALLY AVAILABLE for onclick="" ---
        window.handleLoginClick = () => currentUser ? logout() : showModal('loginModal');
        window.showModal = showModal;
        window.hideModal = hideModal;
        window.switchTab = switchTab;
        window.switchEditTab = switchEditTab;
        window.addPhoto = addPhoto;
        window.removePhoto = removePhoto;
        window.addVideo = addVideo;
        window.removeVideo = removeVideo;
        window.addEditPhoto = addEditPhoto;
        window.removeEditPhoto = removeEditPhoto;
        window.addEditVideo = addEditVideo;
        window.removeEditVideo = removeEditVideo;
        window.addCustomField = addCustomField;
        window.addEditCustomField = addEditCustomField;
        window.deletePet = deletePet;
        window.copyPetLink = copyPetLink;
        window.callOwner = callOwner;
        window.shareLocation = shareLocation;
        window.openEditPetModal = openEditPetModal;
        window.showWelcomeSection = showWelcomeSection;
        window.deletePetConfirm = (petId) => { if(confirm('Bu profili kalıcı olarak silmek istediğinizden emin misiniz?')) deletePet(petId); };
        window.openImageModal = openImageModal;
    </script>
</body>
</html>
