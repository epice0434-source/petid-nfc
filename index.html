<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PatiLink - NFC Hayvan Takip Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script type="module">
      // Bu b√∂l√ºm√º deƒüi≈ütirmeden olduƒüu gibi bƒ±rakƒ±n
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, doc, addDoc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCZSnh9jWibR4a0Pc6RKBDYlGZNXP_Tiu8",
        authDomain: "petnfc-46178.firebaseapp.com",
        projectId: "petnfc-46178",
        storageBucket: "petnfc-46178.appspot.com",
        messagingSenderId: "942096749783",
        appId: "1:942096749783:web:afcd7f8e4f4f109f3c4c92",
        measurementId: "G-XS8LXGR545"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      window.firebase = {
        auth, db, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
        collection, doc, addDoc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, serverTimestamp
      };
    </script>
    
    <style>
        /* Stil kodlarƒ±nƒ±z burada... (deƒüi≈üiklik yok) */
        body { box-sizing: border-box; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .pet-card { transition: all 0.3s ease; transform: translateY(0); }
        .pet-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .stats-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .location-card { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .call-button { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .call-button:hover { background: linear-gradient(135deg, #38f9d7 0%, #43e97b 100%); }
        .emergency-button { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .modal { backdrop-filter: blur(10px); }
        .form-input { transition: all 0.3s ease; }
        .form-input:focus { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .feature-card { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .premium-badge { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
        .notification { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .image-gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .gallery-item { aspect-ratio: 1; border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .gallery-item:hover { transform: scale(1.05); }
        .tab-button.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .admin-stats { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .danger-zone { background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%); }
    </style>
</head>
<body class="min-h-full bg-gray-50">
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <a href="/" class="text-2xl font-bold text-white">üêæ PatiLink</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="loginBtn" class="text-white hover:text-gray-200 px-3 py-2 rounded-md text-sm font-medium">Giri≈ü Yap</button>
                    <button id="registerBtn" class="bg-white text-purple-600 hover:bg-gray-100 px-4 py-2 rounded-md text-sm font-medium">√úye Ol</button>
                </div>
            </div>
        </div>
    </nav>

    <div id="mainContent" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="welcomeSection" class="mb-12">
           </div>
    </div>

    <div id="userDashboard" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
       </div>
    
    <div id="petProfileView" class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
        <div id="petProfileContent"></div>
    </div>
    
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-6 text-center">Giri≈ü Yap</h3>
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">E-posta</label>
                    <input type="email" name="email" class="form-input w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">≈ûifre</label>
                    <input type="password" name="password" class="form-input w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Giri≈ü Yap</button>
            </form>
            <button class="mt-4 w-full text-gray-500 hover:text-gray-700" onclick="hideModal('loginModal')">ƒ∞ptal</button>
        </div>
    </div>
    <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script type="module">
        // --- GLOBAL STATE ---
        let currentUser = null;

        // --- DOM ELEMENT REFERENCES ---
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        // ... diƒüer element referanslarƒ± ...

        // --- UTILITY FUNCTIONS ---
        const showNotification = (message, type = 'info') => {
            const container = document.getElementById('notificationContainer');
            const notif = document.createElement('div');
            const typeClasses = {
                success: 'border-green-500',
                error: 'border-red-500',
                info: 'border-blue-500'
            };
            notif.className = `notification bg-white border-l-4 p-4 rounded-lg shadow-lg max-w-sm ${typeClasses[type]}`;
            notif.innerHTML = `<p>${message}</p>`;
            container.appendChild(notif);
            setTimeout(() => notif.remove(), 5000);
        };

        const showModal = (id) => document.getElementById(id)?.classList.remove('hidden');
        const hideModal = (id) => document.getElementById(id)?.classList.add('hidden');
        
        // --- UI UPDATE FUNCTIONS ---
        const updateNavigation = () => {
            if (currentUser) {
                loginBtn.textContent = '√áƒ±kƒ±≈ü Yap';
                registerBtn.style.display = 'none';
            } else {
                loginBtn.textContent = 'Giri≈ü Yap';
                registerBtn.style.display = 'block';
            }
        };
        
        const showUserDashboard = () => {
            document.getElementById('welcomeSection').classList.add('hidden');
            document.getElementById('petProfileView').classList.add('hidden');
            document.getElementById('userDashboard').classList.remove('hidden');
            // renderPetsList(); // Bu fonksiyonu √ßaƒüƒ±rarak hayvanlarƒ± listeleyin
        };

        const showWelcomeSection = () => {
            document.getElementById('welcomeSection').classList.remove('hidden');
            document.getElementById('petProfileView').classList.add('hidden');
            document.getElementById('userDashboard').classList.add('hidden');
        };

        // --- FIREBASE AUTH FUNCTIONS ---
        const handleLogin = async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;

            try {
                await window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password);
                hideModal('loginModal');
                // Ba≈üarƒ± mesajƒ± g√∂stermeye gerek yok, onAuthStateChanged UI'ƒ± g√ºncelleyecek.
            } catch (error) {
                console.error("Login Error:", error.code);
                let userMessage = "Giri≈ü sƒ±rasƒ±nda bir hata olu≈ütu.";
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential':
                        userMessage = "Girdiƒüiniz bilgilere sahip bir kullanƒ±cƒ± bulunamadƒ±.";
                        break;
                    case 'auth/invalid-email':
                        userMessage = "Ge√ßersiz bir e-posta adresi girdiniz.";
                        break;
                    case 'auth/too-many-requests':
                        userMessage = "√áok fazla ba≈üarƒ±sƒ±z deneme. L√ºtfen daha sonra tekrar deneyin.";
                        break;
                }
                showNotification(userMessage, 'error');
            }
        };

        const handleRegister = async (e) => {
            e.preventDefault();
            // Register logic...
        };

        const logout = () => {
            window.firebase.signOut(window.firebase.auth).catch(error => {
                showNotification(`√áƒ±kƒ±≈ü hatasƒ±: ${error.message}`, 'error');
            });
        };

        // --- CORE AUTH STATE LISTENER ---
        window.firebase.onAuthStateChanged(window.firebase.auth, async (user) => {
            if (user) {
                try {
                    const userDocRef = window.firebase.doc(window.firebase.db, "users", user.uid);
                    const userDoc = await window.firebase.getDoc(userDocRef);

                    if (userDoc.exists()) {
                        currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                        showNotification(`Ho≈ü geldin, ${currentUser.name}!`, 'success');
                        showUserDashboard();
                    } else {
                        // Auth'da var ama Firestore'da yoksa (nadir durum)
                        currentUser = { uid: user.uid, email: user.email, name: 'Kullanƒ±cƒ±' };
                        showNotification('Kullanƒ±cƒ± bilgileriniz y√ºklenemedi.', 'error');
                        showUserDashboard();
                    }
                } catch (error) {
                    console.error("Firestore user document fetch error:", error);
                    showNotification('Kullanƒ±cƒ± verileri okunurken bir hata olu≈ütu. L√ºtfen tekrar giri≈ü yapmayƒ± deneyin.', 'error');
                    logout(); // Hata varsa kullanƒ±cƒ±yƒ± g√ºvenli √ßƒ±kƒ±≈ü yaptƒ±r
                }
            } else {
                currentUser = null;
                // Eƒüer pet profil sayfasƒ±nda deƒüilse ana sayfayƒ± g√∂ster
                if (!window.location.search.includes('pet=')) {
                     showWelcomeSection();
                }
            }
            updateNavigation();
        });

        // --- EVENT LISTENERS ---
        loginBtn.addEventListener('click', () => {
            if (currentUser) {
                logout();
            } else {
                showModal('loginModal');
            }
        });
        registerBtn.addEventListener('click', () => showModal('registerModal'));
        loginForm.addEventListener('submit', handleLogin);
        registerForm.addEventListener('submit', handleRegister);
        
        // Make modal functions globally available for inline onclick
        window.showModal = showModal;
        window.hideModal = hideModal;

    </script>
</body>
</html>
